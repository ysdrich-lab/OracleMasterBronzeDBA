# 9.DBの監視及びアドバイザの使用

## 1.DBの監視
* Oracle Enterprise Manager Database Express(EM Express)で行う

### 1.EM Express[DB・ホーム]ページ
* DBの状態とワークロードを関しできる
  * ステータス：DBの状態の概要
  * パフォーマンス：アクティブなセッション管理
  * リソース：最新のデータポイント（過去1分間）のリソース使用率
  * インシデント：DBの内でのクリティカルエラーの発生
  * 実行中のジョブ：現在実行されてるDBジョブ
  * SQL監視：SQLのアクティビティ

### 2.EM Express[パフォーマンス・ハブ]ページ
* 指定した期間に応じたパフォーマンスデータを表示
  * デフォルトでは過去1時間のリアルタイムデータ
  * サマリー：指定した期間のシステムのパフォーマンス包括的ビュー
  * アクティビティ：アクティブセッション履歴（ASH）分析
  * ワークロード：過去60分間のユーザコール、秋積コール、REDOサイズ、SQL*Netのパターンをリアルタム表示
  * 監視対象SQL：選択した期間に実行中であったか完了した監視対象のSQLに関する情報
  * ADDM：選択した期間にDB内で実行されたタスクに対して、ADDMによって検出されたパフォーマンスの結果と推奨事項

## 2.Oracle自己監視アーキテクチャ
* OracleDBが自DBを自己監視・診断するための機能

### 1.AWR：自動ワークロードリポジトリ
* 統計情報とワークロード情報を自動収集・管理する機能
  * OracleDBの問題検出/自己チューニングを目的とする
* OracleDBに組み込まれた機能
  * 特に追加インストール等は不要

#### AWRスナップショット
* ある時点の統計情報とワークロード情報のこと
* DBの稼働状況を分析、改善策を提示するための基礎データ
* SYSAUX表領域に保存される
* デフォルトは60分間隔で保存される
* SYSAUX表領域に8日間保存される
* 保存間隔・保存期間は変更可能

### 2.ADDM：自動DB診断モニタ
* OracleDBに東西された自己診断エンジン
* OracleDBによって、DB自身のパフォーマンスが診断される
  * 問題解決方法を数値化した効果とともに管理者に推奨する

* AWRスナップショットが生成されるたび、AWRスナップショットを元に自動的に実行される
* 分析結果はSYSAUX表領域内のAWRに格納される
* 分析の結果、パフォーマンス上の問題が見つかると、EM Expressの「DB・ホーム
ページに報告される
* DBがOPENされていない状態では分析を行えない
* ADDMは分析の結果に応じて、アドバイザ機能を実行する場合がある
* ADDMは手動で実行することも可能

## 3.アドバイザによるパフォーマンスの診断

### 1.様々なアドバイザ
* ADDM:DB全体のアドバイスを提供する
* メモリアドバイザ
  * メモリアドバイザ：自動メモリ管理モードの場合、インスタンス全体のメモリを最適化する
  * PGAアドバイザ：自動PGAのメモリ管理モードの場合、PGAの全体のメモリを最適化する
  * SGAアドバイザ：自動共有メモリ管理モードの場合,SGAの構成に関する各コンポーネントサイズを最適化する
  * 共有プールアドバイザ：共有プールの最適サイズを提供する
  * データバッファキャッシュアドバイザ：データバッファキャッシュの最適サイズを提供する
* SQLアドバイザ
  * SQLチューニングアドバイザ：パフォーマンスを向上させる推奨項目(SQLの書き換え、索引作成の推奨)を作成する
  * SQLアクセスアドバイザ：SQLを実行する際のアクセスパスに関するチューニング（索引、マテリアライズド・ビューの作成）を推奨する

### 2.SQLチューニングアドバイザ

#### SQLチューニングと実行計画
* OracleDBでSQLを実行する際、オプティマイザと呼ばれる内部コンポーネントが、SQLの実行手順を作成する
  * これが実行計画
  * 表などのデータにアクセスする経路のこと：アクセスパス
  * オプティマイザ統計情報をもとに実行計画を作成する

#### SQLチューニングアドバイザと推奨事項
* 高負荷のSQLを分析し、パフォーマンス向上のための推奨事項を出力する
  * オプティマイザ統計の収集
  * 新規索引の作成
  * SQLの修正
  * SQLプロファイルの作成
* DB管理者は、推奨事項の内容を見て、実装するかを判断する

#### SQLチューニングアドバイザの入力
* トップアクティビティ：過去1時間に実行されたSQLのうち、最もリソースの使用量が多かったSQLが評価される
  * 直近の1時間においてリソース使用量が多かったSQLをチューニングする
* 履歴SQL：24時間単位でSQLをチューニングする
  * 1日を振り返り、リソースの使用量が多かったSQLをチューニングする
* STS（SQLチューニングセット）：AWRにスナップショットによって首都kス荒れたSQLor任意のSQLワークロードから作成された一連のSQLが評価される
  * 様々なソースからSQLをロード可能なSQLチューニングセット

#### SQLチューニングセット
* SQLのセット
* SQLが実行された状況を示す情報(実行コンテキスト)
* SQL実行時の実行統計
  * 経過時間
  * CPU時間
  * バッファ読み取り
  * ディスク読み取り
  * 処理された行数etc
* SQLを追加するには、AWR、共有プールなどから情報を登録する
* 手動登録も可能

### 3.自動SQLチューニングタスク
* SQLチューニングアドバイザを自動的に実行する仕組み
* AWRから負荷の大きい問い合わせを選択、SQLチューニングアドバイザを実行、推奨事項を出力
  * 出力された推奨事項がSQLプロファイルの場合、自動的に有効化する事も可能
  * SQLプロファイル以外の場合、自動有効化されない

### 4.SQLアクセスアドバイザ
* オブジェクト構成の改善を推奨するアドバイザ機能
  * 索引
  * マテリアライズドビュー
  * パーティション表の作成、変更、削除
* SQLワークロードの分析対象とする
* SQLワークロードに複数のSQLの実行を最適化するオブジェクト構成を推奨する
* 次のソースから分析対象とするSQLワークロードを特定する
  * 共有プール
  * SQLチューニングセット
  * 仮想ワークロード（オブジェクト構成から推測した疑似ワークロード）