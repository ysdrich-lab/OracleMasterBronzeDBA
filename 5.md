# 5.Oracleインスタンスの管理

## 1.インスタンス
### 1.インスタンスとは
* OracleDBのデータ処理の中心となる常駐部分
  * OracleDBを使用するにはインスタンスを起動しておく必要がある
* SGA:SystemGlobalAreaとバックグラウンドプロセスから成る
* **1つのインスタンスは1組のDBファイルに対応**
  * 1つのインスタンス<->2組以上のDBファイルはダメ
  * 2つ以上のインスタンス<->2組以上のDBファイルもダメ
  * インスタンスとDBファイル群は同じコンピュータ上に配置

### 2.バックグラウンドプロセス
* インスタンス起動時にSGAのメモリ割り当てと併せて起動されるいくつかのプロセスの総称
* 特定の接続に限定されない、OracleDB全体の処理を担う
    * DBwn:データベースライター
      * DBバッファキャッシュ内の更新済みブロックをデータファイルに書き込む
    * LGWR:ログライター
      * REDOログバッファのREDOデータをREDOログファイルに書き出す
    * CKPT:チェックポイント
      * DBWnに対して、DBバッファキャッシュ内の更新済みブロックをデータファイルに書き込む支持を出す
      * 制御ファイルにチェックポイント情報を書き込む
    * SMON:システムモニタ
      * インスタンスが異常終了した場合、次回インスタンス起動時にDBファイルの整合性を復旧する処理を実行する
    * PMON:プロセスモニタ
      * プロセスが異常終了した場合、そのプロセスが使用していた様々なデータやリソースの後処理を実行する
    * MMON:管理モニタ
      * 性能分析などで仕様される統計情報を定期収集する
    * ARCn:アーカイバ
      * ログスイッチの発生後、REDOログファイルのREDOデータをアーカイブログファイルとしてコピーする

### 3.SGA(システムグローバル領域)
* インスタンス起動時に割り当てられるメモリ領域
* プロセス間で共有されるデータが保管される
* コンポーネント：SGA内にある、用途に応じたいくつかのメモリ領域
  * DBバッファキャッシュ
    * データファイルから読み込んだブロックをキャッシュ
    * 更新済みブロックを一時的に保管（バッファ）
  * 共有プール
    * 解析済みのSQLやデータディクショナリなどの情報をキャッシュする
  * REDOログバッファ
    * REDOログファイルに書き込む前のREDOデータを一時的に保管する
  * Javaプール
    * Javaで記述されたストアドプログラムの実行に使用される
  * ラージプール
    * バックアップや並列処理などの作業領域として使用される

### 4.DBバッファキャッシュ
* ブロックの読み出しと書き込みの性能を向上させるためのメモリ領域
* DBバッファキャッシュを介して、ブロックの読み出し/書き込みを行う
  * キャッシュ機能
    * データファイルから参照を行う際、一旦データファイルからSGA内のDBバッファキャッシュにブロックを保管する
    * 次に同じブロックを読み出す際、DBバッファキャッシュから読み出す
  * バッファ機能
    * Oracleで更新処理を行う際、DBバッファキャッシュにあるブロックが更新される
      * メモリ上のブロックだけを更新するため、処理が高速
      * 同一ブロックを複数回更新する際、データファイルへの書き込みを1回に減らせる
      * DBWn:データベースライターにより後でデータファイルに書き込まれる
### 5.REDOログバッファ
* 更新時、データファイルに書き出される前（DBバッファキャッシュに書き込まれた後）でインスタンス障害が発生すると、ブロックの更新が失われてしまう
* これを防ぐため、REDOデータ：更新履歴を生成する
* 更新を確定したタイミング(=トランザクションをコミットしたタイミング)でREDOログファイルに書き込まれる
* 書き込む前のREDOデータを一時保管するメモリ領域：REDOログバッファ

### 6.共有プール
* 性能向上のため様々な情報をキャッシュするメモリ領域
  * 解析済みSQLの情報：
    * 同一のSQLを実行する場合、共有プールから使用することで、時間短縮/負荷低減
    * データディクショナリの情報：
      * Oracleは様々な処理でデータディクショナリ：DBの内部管理情報に繰り返しアクセスするため、
      * データディクショナリの情報をキャッシュすることで性能向上
### 7.PGA(プログラムグローバル領域)
* 特定のOracleプロセス専用のメモリ領域
* サーバプロセス、バックグラウンドプロセスなど、それぞれのプロセス専用のメモリ領域
* 専用だからプロセス間で共有はされない
  * ソート処理などのプロセス専用の作業用メモリ領域

## 2.インスタンスの起動/停止
### 1.インスタンスの起動
* OracleDBを利用するためには、インスタンスを起動し、DBをオープンにする必要がある
* DBオープンまでに4ステップある
  * SHUTDOWN状態
    * インスタンスが停止中
    * DBもクローズ状態
  * NOMOUNT状態
    * インスタンスが起動した状態
    * SGAが割り当てられ、バックグラウンドプロセスが起動
    * データファイル、REDOログファイルにはあkすえすしない
    * DBはオープンしていない
  * MOUNT状態
    * 制御ファイルが読み書き可能な状態
  * OPEN状態
    * DBがオープンした状態
    * REDOログファイル、データファイルが読み書き可能
#### SHUTDOWN状態->NOMOUNT状態
  * **初期化パラメータファイル**を読み込む
    * 初期化パラメータに従ってインスタンスを起動する
  * メモリ上にSGAが割り当てられて、バックグラウンドプロセスが起動される
#### NOMOUNT状態->MOUNT状態
  * インスタンスが制御ファイルをオープンする
    * 制御ファイル名は初期化パラメータファイル内に、**CONTROL_FILES**として格納されている
    * 全ての制御ファイルのオープンが完了すると、MOUNT状態になる
      * 1つでも制御ファイルのオープンに失敗するとMOUNT状態に遷移できない
#### MOUNT状態->OPEN状態
  * インスタンスがデータファイル、REDOログファイルをオープンする
    * データファイル、REDOログファイルのパスは制御ファイルに格納されてる
  * 2つのファイルのオープンが完了するとオープン状態になる
  * 特殊な管理権限を持たない通常ユーザが接続可能になる
  * DBに格納されたデータにアクセス可能になる
#### 障害判断
* 初期化パラメータファイルに障害
  * NOMOUNT状態への遷移に失敗、SHUTDOWN状態のまま
* 制御ファイルに障害
  * MOUNT状態への遷移に失敗、NOMOUNT状態でインスタンス起動処理が停止
* データファイル/REDOファイルに障害
  * OPEN状態への遷移に失敗、MOUNT状態でインスタンス起動処理が停止

#### SQL*Plusでインスタンス起動
* startupコマンドでインスタンス起動
  * SYSDBA権限、SYSOPER権限、SYSBACKUP権限などを付与されたユーザで接続する必要がある
  * SYSユーザにはSYSDBA権限が付与されている
### 2.初期化パラメータ
* インスタンスの動作特性を決定するパラメータ
* 数百種類のパラメータがある
* 初期化パラメータファイルに記載
* 下記は一部
  * CONTROL_FILES：制御ファイルのファイル名、複数指定可能
  * DISPATCHERS：ディスパッチャプロセスの構成
  * MEMORY_MAX_TARGET：MEMORY_TARGET初期化パラメータの上限値
  * MEMORY_TARGET：全SGAコンポーネントと全プロセスのPGAの合計サイズ。自動メモリ管理使用時に設定
  * PGA_AGGREGATE_TARGET：全プロセスのPGAの合計サイズ目標値。自動PGAメモリ管理使用時に設定
  * SHARED_POOL_SIZE共有プールのサイズ
  * SGA_MAZX_SIZE：全SGAコンポーネントの合計サイズの上限
  * SGA_TARGET：全てのSGAコンポーネントの合計サイズ。自動共有メモリ管理使用時に設定
  * UNDO_RETENTION：UNDO保存の下限（秒）
* 上記初期化パラメータは静的/動的に分かれる
  * 動的初期化パラメータ
    * 起動中に変更可能なもの
    * DISPATCHERS,MEMORY_TARGET,PGA_AGGREGATE_TARGET,SHARED_POOL_SIZE,SGA_TARGET,UNDO_RETENTION
    * ALTER SYSTEMコマンドでインスタンス起動中に設定値を変更できる
  * 静的初期化パラメータ
    * 起動中に変更不可能なもの
    * CONTROL_FILES,MEMORY_MAX_TARGET,SGA_MAX_SIZE
    * ALTER SYSTEMコマンドに、SCOPE=SPFILEオプションを指定してパラメータファイルの設定を書き換える
      * インスタンス再起動時に設定が変更される
### 3.初期化パラメータファイル
* サーバパラメータファイル(SPFILE)
  * 今主流う
  * バイナリ形式のため直接編集不可能
  * SQL(ALTER SYSTEM)で編集
* テキスト形式のパラメータファイル(PFILE)
  * テキスト形式だから直接編集可能
  * SQLで修正不可能

### 4.インスタンスの停止
* OSの再起動時やメンテナンス作業時に、インスタンスを停止する必要がある
* DBがクローズされ、DB内のデータにアクセスできなくなる
* SQL\*Plusで**shutdownコマンドを実行する**
  * SYSDBA権限等特殊権限を持ったユーザで実行
  * shutdownコマンドには4種類のオプションがある
#### NORMAL
* すべての接続が終了されるまで待機
* その後インスタンスの停止処理を行う
* オプション未設定時のデフォルト
#### TRANSACTIONAL
* 実行中のトランザクションが終了されるまで待機
* その後インスタンスの停止処理を行う
* 接続中ユーザはトランザクション終了時に切断される
#### IMMEDIATE
* 実行中の処理を取り消す
* その後インスタンスの停止処理を行う
* 接続中ユーザは切断される
#### ABORT
* 実行中の処理は強制終了される
  * DBファイルは整合性が取れていない状態になる
  * 次回インスタンス起動時に自動的に回復される
* その後インスタンスの停止処理を行う
* 接続中ユーザは切断される

## 3.メモリコンポーネントの管理
### 1.Oracleのメモリサイズ自動調整機能
### 2.自動メモリ管理
### 3.自動共有メモリ管理
### 4.自動PGAメモリ管理