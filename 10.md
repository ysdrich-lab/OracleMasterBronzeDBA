# 10.バックアップ・リカバリの概要と可用性を高める構成

## 1.バックアップ・リカバリの概要

### 1.メディア障害とメディアリカバリ
* メディア障害：DBファイルの破損
  * ストレージ装置の移乗動作、故障、DB管理者の作業ミスによるファイル誤削除等で発生
* メディアリカバリ：メディア障害の復旧手段

* 基本的に過去に取得したバックアップを戻すことで復旧作業を行う
* 破損ファイルの種類によって具体的な復旧手段は異なる
  * 今回はデータファイルの破損に関して記載
1. メディア障害発生前の正常な状態で、DBバックアップを取得しておく
    * 取得したバックアップをメディアリカバリで使用する
2. メディア障害発生時に実行する復旧作業は、バックアップを戻す**リストア**と、REDOデータを適用する**リカバリ**から構成される
3. リストアを実行することで、DBをバックアップ取得時点の状態に戻せる
4. リカバリを実行することで、DBを障害発生直前の状態にすることができる

* Oracleに標準で含まれるRecovery Manager(RMAN)というツールを使用する
* リカバリによって、DBをバックアップ取得時点から障害発生直前に進める事をロールフォワードと呼ぶ

### 2.ARCHIVELOGモード
* メディアリカバリを行うためのモード
* DBのOPEN中にバックアップを取得できる
  * 非一貫性バックアップ
* ARCHIVELOGモードで運用していないDBは、メディアリカバリを実行できない
* DBをARCHIVELOGモードに変更すると、REDOデータを含むアーカイブログファイル(アーカイブREDOログファイル)が指定されたディレクトリ以下に出力される
  * アーカイブ
  * この処理は、ARCn（アーカイバプロセス）が実行する
  * アーカイブにより、DBに対する一連の変更履歴を保管できる
    * ローテーションにより、REDOログファイルは上書きされるが、REDOデータがアーカイブログファイルとして保管されている
#### ARCHIVELOGモードの構成
* 高速リカバリ領域の構成
  * 高速リカバリ領域のサイズと場所を指定する
  * アーカイブログファイルを含む、リカバリ関連のファイルを一元的に格納するためのストレージ領域
    * 制御ファイル、REDOログファイルの多重化コピーを配置する場合もある
  * 実体は、DB_RECOVERY_FILE_DEST初期化パラメータで表示されるディレクトリ以下の記憶域
    * 以前（11g R1以前）はフラッシュリカバリ領域と呼ばれていた
* ARCHIVELOGモードに変更
  * MOUNTモードでALTER DATABASE ARCHIVELOGコマンドを実行する
* 初期化パラメータにて、下記2点を設定する
  * DB_RECOVERY_FILE_DEST:配置ディレクトリ
  * DB_RECOVERY_FILE_DEST_SIZE:サイズ
* 構成されている場合、デフォルトでアーカイブログファイルは高速リカバリ領域に出力される

#### ARCHIVELOGモードへの変更

```
$ sqlplus / as sysdba

SQL> ALTER SYSTEM SET DB_RECOVERY_FILE_DEST = '/u01/app/oracle/fast_recovery_area';

SQL> ALTER SYSTEM SET DB_RECOVERY_FILE_DIST_SIZE = 10G;

SQL> shutdown immediate

SQL> startup mount

SQL> ALTER DATABASE ARCHIVELOG;

SQL> ALTER DATABASE OPEN;

```

#### ARCHIVELOGモードとNOARCHIVELOGモードの比較

|                    | ARCHIVELOGモード               | NOARCHIVELOGモード |
|--------------------|-----------------------------|-----------------|
| 使用が想定されるシステム       | 本番環境                        | 開発環境、検証環境       |
| 非一貫性バックアップ         | 可能                          | 不可              |
| データファイル単位の順位バックアップ | 可能                          | 不可              |
| 障害発生直前時点への復旧       | 可能                          | 不可              |
| 実施スべき運用作業          | 定期的なバックアップ、古いアーカイブログファイルの削除 | 定期的なバックアップ      |

### 3.DBのバックアップ
* DBファイルを別の安全な場所にコピーすること
* RMANでBACKUP DATABASEコマンドを実行するだけで取得可能

```
RMAN> BACKUP DATANASE; 
```
* 全てのデータファイル、制御ファイル、SPFILEをバックアップ対象とする
  * 一部のデータファイルをバックアップしただけでは、障害発生時に復旧できない

* 2種類のファイル形式でバックアップを取得できる
  * バックアップセット：RMAN独自のフィアル形式
    * 未使用領域の圧縮、暗号化など様々なRMAN拡張機能が利用可能
    * 一般的にこっちが利用される
  * イメージコピー
    * バックアップ元ファイルと物理的に同一のコピー
    * ファイルサイズは、バックアップ元のファイルサイズと一緒

#### 非一貫性バックアップと一貫性バックアップ
* 非一貫性バックアップ
  * DBのOPEN中に取得したバックアップのこと
    * オンラインバックアップ、ホットバックアップとも呼ぶ
  * 非一貫性＝悪いことではない
  * バックアップを非一貫性バックアップとして取得する運用が一般的
* 一貫性バックアップ
  * DBを停止して取得するバックアップ
    * オフラインバックアップ、コールドバックアップとも呼ぶ


### 4.リストアとリカバリ
* リストア
  * 破損したファイルを予め取得しておいたバックアップで置き換えること
* リカバリ
  * REDOデータを適用し、ロールフォワードして、ファイルを障害発生直前の状態にすること

```
RMAN> RESTORE DATAFILE '/u01/app/oracle/oradata/ORCL/users01.dbf';

RMAN> RECOVER DATAFILE '/u01/app/oracle/oradata/ORCL/users01.dbf';

RMAN> ALTER TABLESPACE users ONLINE;
```

### 5.バックアップおよびリカバリの実行に必要穴権限
* SYSDBA権限orSYSBACKUP権限が必要
* SYSDBA権限でのRMAN接続
  * 特に指定しない場合,SYSDBA権限で接続される
    * `$ rman target /`
  * targetは、バックアップ対象のDB（ターゲットDB）に接続すること
    * 上記コマンドはOS認証の例
* SYSBACKUP権限でのRMAN接続
  * `$ rman target '"sysbackup/Password123 as sysbackup"`
  * rmanコマンドに、AS SYSBACKUPを指定する場合、シングルクォートとダブルクォートが必要

### 6.不完全リカバリ

* 障害発生直前ではなく、指定した過去のある時点にDBを復旧する方法
* DBを過去の状態に戻したい時や、完全リカバリが実行できない障害発生時
* Point-in-Timeリカバリとも呼ぶ

### 7.メディア障害以外の障害対応
* トランザクション実行中の意図しないセッションの切断
* インスタンスの異常終了
  * 上記2点に関しては、Oracleが自動的に復旧作業を行う
* メディア障害
* ユーザの誤操作によるデータの喪失
  * 上記2点に関しては、DB管理者or一般うー座のフラッシュバック操作が必要

## 2.可用性を高める構成
### 1.OracleDBの重要な用語
* Oracle Real Application Clusters(RAC)
  * 複数のDBサーバを連携して動作させる構成
  * DBサーバやインスタンスに障害が発生した場合でもサービスを継続できる
  * 複数のDBサーバで、ストレージは共有
    * データファイル等も共有
  * スケールアウト：DBを停止すること無くDBサーバを追加し、性能向上ができる
  * キャッシュフュージョン：DBバッファキャッシュにキャッシュされたブロックをDBサーバ感で共有、高い性能を実現

* Oracle Clusterware
  * RAC構成で複数のDBサーバを連携して動作するために必要なソフトウェア
  * Oracle DBには含まれていない。Oracle Grid Infrastructureに含まれる
  * DB上のインスタンスやプロセスを監視し、障害発生時にプロセスを起動するDBサーバの変更や、サービスの引き継ぎ処理を実行する

* Oracle Automatic Storage Management(ASM)
  * 共有ストレージに対応したクラスタファイルシステム機能を実現するアプリケーション
  * クラスタファイル機能に加えて
    * 複数のストレージ統合、ストレージ管理を簡素化
    * ストレイピング：並列書き込み、並列読み込みを行って性能を向上させる
    * 同一データを複数ストレージに重複書き込みして、対象外性を高める
  * Oracle DBには含まれていない。Oracle Grid Infrastructureに含まれる
  * ASMインスタンスと呼ばれる特殊なインスタンスを起動する必要がある

* Oracle Data Guard
  * データセンターレベル、地域レベルなど比較的大規模の災害を想定した機能
  * 通常使用するDB：プライマリ・データベースとして、
  * 遠隔地にスタンバイDBと呼ばれる予備DBを作成する
  * プライマリDBに障害が発生した際、スタンバイDBを使用する（フェイルオーバー）
  * REDOデータを伝播して適用する
  * 平常時はスタンバイDBを読み取り専用でオープンして、レポート生成やバックアップ取得等の負荷の高い処理をスタンバイDBで実行できる（オフロード）
  * REDOデータの適用の違いによって、
    * フィジカルスタンバイDB
    * ロジカルスタンバイDB
  * 一般に使用されるのはフィジカルスタンバイDB